# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.

jobs:
  build:
    machine: true
    steps:
      - checkout
      - run: git submodule sync
      - run: git submodule status --cached external/llvm-project > llvm_module.txt
      - run: mkdir -p build/llvm-project build/omtalk
      - restore_cache:
        name: Restoring cached llvm build
        key: llvm-{{ arch }}-{{ checksum "llvm_module.txt" }}-v1
      - run: .circleci/build_llvm.sh
      - save_cache:
        paths:
          - ~/llvm
        key: llvm-{{ arch }}-{{ checksum "llvm_module.txt" }}-v1
        name: "Caching llvm build"
      - run: .circleci/update_submodules.sh
# Orchestrate or schedule a set of jobs
workflows:
  # Name the workflow "welcome"
  build-with-machine:
    # Run the welcome/run job in its own container
    jobs:
      - build